<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="arraysort.project.board.app.image.mapper.ImageMapper">

    <!-- 이미지 추가 -->
    <insert id="insertImages" useGeneratedKeys="true" keyProperty="imageId">
        insert into image(original_name,
                          saved_name,
                          size,
                          image_path,
                          created_by)
        values
                (#{originalName},
                 #{savedName},
                 #{size},
                 #{imagePath},
                 #{createdBy})
    </insert>

    <!-- 게시글 이미지 관계 추가 -->
    <insert id="insertPostImage">
        insert into post_image (post_id, image_id)
        values
            <foreach collection="postImages" item="postImage" separator=",">
                (#{postImage.postId}, #{postImage.imageId})
            </foreach>
    </insert>

    <!-- 게시글 세부조회 -> 이미지 리스트 조회 -->
    <select id="selectImagesByPostId" resultType="arraysort.project.board.app.image.domain.ImageVO">
        select i.image_id,
               i.original_name,
               i.saved_name,
               i.size,
               i.image_path,
               i.created_by,
               i.created_at,
               i.delete_flag
        from image i
        inner join post_image pi on i.image_id = pi.image_id
        where pi.post_id = #{postId} and i.delete_flag = 'N'
    </select>

    <!-- 게시글 세부조회 -> 이미지 조회 -->
    <select id="selectImageById">
        select image_id,
               original_name,
               saved_name,
               size,
               image_path,
               created_by,
               created_at,
               delete_flag
        from image
        where image_id = #{imageId}
    </select>

    <!-- 게시글 수정 -> 이미지 삭제 -->
    <update id="deleteImages">
        update image
        set delete_flag = 'Y'
        <if test="imageIds != null and imageIds.size() > 0">
            where image_id in
            <foreach collection="imageIds" item="imageId" open="(" separator="," close=")">
                #{imageId}
            </foreach>
        </if>
    </update>

    <!-- 게시글 이미지 관계 삭제 -->
    <delete id="deletePostImageByPostId">
        delete
        from post_image
        <if test="imageIds != null and imageIds.size() > 0">
            where image_id in
            <foreach collection="imageIds" item="imageId" open="(" separator="," close=")">
                #{imageId}
            </foreach>
        </if>
    </delete>

    <!-- 게시글에 존해하는 이미지 개수 조회 -->
    <select id="selectImageCountByPostId" resultType="int">
        select count(*)
        from post_image
        where post_id = #{postId}
    </select>

</mapper>
